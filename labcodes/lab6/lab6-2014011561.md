# Lab 5 实验报告

#### 2014011561 张欣阳

> 注：为了在mac下编译，修改了Makefile文件，如果不能编译，请使用Makefile.bk

--------------------------------------------------------------------------------

## 练习0：更新以往lab
第一处需要更新的地方是proc.c中`alloc_proc`函数，由于我们改进了proc_struct数据结构，所以新引入的字段需要初始化，更新如下：
```c
proc->rq = NULL;    // set running queue to NULL
list_init(&(proc->run_link));   // init run_link list
proc->time_slice = 0;
// for skew heap data structure, set parent, left, right pointer to NULL
proc->lab6_run_pool.left = proc->lab6_run_pool.right = proc->lab6_run_pool.parent = NULL;
proc->lab6_stride = 0;
proc->lab6_priority = 0;
```
running queue设置为NULL，run_link链表用`list_init`函数初始化。新引入的斜堆数据结构每个节点有三个字段，父节点、左孩子和右孩子，都设置为NULL。其余字段初始化为0。

第二处需要更新的地方是trap.c中的`trap_dispatch`函数。在上一个lab中，我们直接在时钟周期达到`TICK_NUM`的时候将`current->need_resched`设置为1；然而在本lab中，我们对idleproc和其他进程做区分处理。sched.c中定义了函数`sched_class_proc_tick`，在时间片用完时，对一般进程设置`need_resched`为1，而对idleproc调用`proc_tick`函数。我们在此利用这个函数，修改如下：
```c
if (ticks % TICK_NUM == 0) {
    // print_ticks();
    assert(current != NULL);
    sched_class_proc_tick(current);
}
```
同时我们对sched.c中的`sched_class_proc_tick`做修改，去掉其static修饰，再在sched.h中加入这个函数的定义，以便在trap.c中调用这个函数。
